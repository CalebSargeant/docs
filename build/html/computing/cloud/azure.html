

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Azure &mdash; Caleb Sargeant&#39;s Docs 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cloudflare" href="cloudflare.html" />
    <link rel="prev" title="Cloud" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Caleb Sargeant's Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../networking/cisco/index.html">Cisco</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/fortigate.html">FortiGate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/hp.html">HP Procurve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/juniper.html">Juniper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/ubiquiti-unifi.html">Ubiquiti UniFi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/netdevops-toolchest.html">NetDevOps Tool Chest</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Computing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ansible/index.html">Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bamboo.html">Bamboo</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cloud</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Azure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sentinal">Sentinal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#az-cli">Az-CLI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-tunnels">Creating Tunnels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tunnel-config-on-asa">Tunnel Config on ASA</a></li>
<li class="toctree-l4"><a class="reference internal" href="#public-ip">Public IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions">Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resize-disk">Resize Disk</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#azure-powershell">Azure Powershell</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modifying-ipsec-policies">Modifying IPSec Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-aadds">Deploy AADDS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#connection-troubleshooting">Connection Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gui">GUI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli">CLI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cloudflare.html">Cloudflare</a></li>
<li class="toctree-l2"><a class="reference internal" href="digicert.html">DigiCert</a></li>
<li class="toctree-l2"><a class="reference internal" href="duo.html">Duo</a></li>
<li class="toctree-l2"><a class="reference internal" href="openstack.html">Openstack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../containerisation/index.html">Containerisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jenkins/index.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terraform/index.html">Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../microsoft/index.html">Microsoft</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../programming/bash.html">Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming/python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming/golang/index.html">Golang</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../other/api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/general/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/iperf.html">iPerf3</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Caleb Sargeant's Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Cloud</a> &raquo;</li>
        
      <li>Azure</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/computing/cloud/azure.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="azure">
<h1>Azure<a class="headerlink" href="#azure" title="Permalink to this headline">¶</a></h1>
<div class="section" id="sentinal">
<h2>Sentinal<a class="headerlink" href="#sentinal" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/sentinel/connect-syslog">https://docs.microsoft.com/en-us/azure/sentinel/connect-syslog</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/sentinel/connect-common-event-format">https://docs.microsoft.com/en-us/azure/sentinel/connect-common-event-format</a></p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/sentinel/connect-syslog">https://docs.microsoft.com/en-us/azure/sentinel/connect-syslog</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/sentinel/connect-cef-solution-config">https://docs.microsoft.com/en-us/azure/sentinel/connect-cef-solution-config</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/sentinel/connect-cef-verify">https://docs.microsoft.com/en-us/azure/sentinel/connect-cef-verify</a></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="az-cli">
<h2>Az-CLI<a class="headerlink" href="#az-cli" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-tunnels">
<h3>Creating Tunnels<a class="headerlink" href="#creating-tunnels" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">## Create a Gatway Subnet for VNET</span>
az network vnet subnet create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --vnet-name <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">&quot;</span> -n <span class="s2">&quot;GatewaySubnet&quot;</span> --address-prefix <span class="s2">&quot;10.</span><span class="nv">$SUBNUM</span><span class="s2">.207.224/27&quot;</span>

<span class="c1">## Create a Public IP Address for VGW (https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#can-i-request-a-static-public-ip-address-for-my-vpn-gateway)</span>
az network public-ip create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VGW_PIP</span><span class="s2">&quot;</span> --allocation-method <span class="s2">&quot;dynamic&quot;</span>

<span class="c1">## Create a VNET Gateway</span>
az network vnet-gateway create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VGW_NAME</span><span class="s2">&quot;</span> --vnet <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">&quot;</span> --public-ip-addresses <span class="s2">&quot;</span><span class="nv">$VGW_PIP</span><span class="s2">&quot;</span> --sku <span class="s2">&quot;Standard&quot;</span>

<span class="c1">## Create a local-gateway (VPN Peer) to connect to</span>
az network local-gateway create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$LGW1</span><span class="s2">&quot;</span> --gateway-ip-address <span class="s2">&quot;</span><span class="nv">$PIP1</span><span class="s2">&quot;</span> --local-address-prefixes <span class="s2">&quot;</span><span class="nv">$SUBNET</span><span class="s2">&quot;</span>

<span class="c1">## Create the tunnel on Azure&#39;s side</span>
az network vpn-connection create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$CON1</span><span class="s2">&quot;</span> --vnet-gateway1 <span class="s2">&quot;</span><span class="nv">$VGW_NAME</span><span class="s2">&quot;</span> --local-gateway2 <span class="s2">&quot;</span><span class="nv">$LGW1</span><span class="s2">&quot;</span> --shared-key <span class="s2">&quot;</span><span class="nv">$PSK</span><span class="s2">&quot;</span>

<span class="c1">## VNET to VNET Tunnels</span>
<span class="k">for</span> XX <span class="k">in</span> <span class="nv">$OTHER_REGIONS</span><span class="p">;</span> <span class="k">do</span>
  <span class="nv">VGW_ID</span><span class="o">=</span><span class="k">$(</span>az network vnet-gateway show -g <span class="s2">&quot;</span><span class="nv">$XX</span><span class="s2">-RSG&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$XX</span><span class="s2">-VPN-GW&quot;</span> <span class="p">|</span> grep id <span class="p">|</span> head -n1 <span class="p">|</span> awk -F <span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $4}&#39;</span><span class="k">)</span>
  az network vpn-connection create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">-</span><span class="nv">$XX</span><span class="s2">-VNET&quot;</span> --vnet-gateway1 <span class="s2">&quot;</span><span class="nv">$VGW_NAME</span><span class="s2">&quot;</span> --vnet-gateway2 <span class="s2">&quot;</span><span class="nv">$VGW_ID</span><span class="s2">&quot;</span> --shared-key <span class="s2">&quot;</span><span class="nv">$VNET_PSK</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
</div>
<div class="section" id="tunnel-config-on-asa">
<h3>Tunnel Config on ASA<a class="headerlink" href="#tunnel-config-on-asa" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ASA_PEER</span><span class="o">=</span><span class="k">$(</span>az network public-ip show -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VGW_PIP</span><span class="s2">&quot;</span> --query ipAddress -o tsv<span class="k">)</span>
<span class="nv">ASA_PEER_NAME</span><span class="o">=</span><span class="s2">&quot;CORP-AZURE-</span><span class="nv">$REGION_PREFIX</span><span class="s2">-</span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span>
<span class="nv">ASA_REMOTE_SUBNET</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$VNET_PREFIX</span><span class="s2">&quot;</span> <span class="p">|</span> grep -o <span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="k">)</span>

<span class="c1"># Generate Azure tunnel configuration</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$REGION_PREFIX</span><span class="s2">.ps1&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;# This file is generated by scriptPX&quot;</span>  &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;\$POLICY = New-AzIpsecPolicy -IkeEncryption AES</span><span class="nv">$P1_AES</span><span class="s2"> -IkeIntegrity SHA</span><span class="nv">$P1_SHA</span><span class="s2"> -DhGroup DHGroup</span><span class="nv">$DH_GROUP</span><span class="s2"> -IpsecEncryption GCMAES</span><span class="nv">$P2_GCM_AES</span><span class="s2"> -IpsecIntegrity GCMAES</span><span class="nv">$P2_GCM_AES</span><span class="s2"> -PfsGroup PFS</span><span class="nv">$DH_GROUP</span><span class="s2"> -SALifeTimeSeconds 14400 -SADataSizeKilobytes 102400000&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;\$RSG = \&quot;</span><span class="nv">$RSG</span><span class="s2">\&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;\$Connections = @(\&quot;</span><span class="nv">$CON1</span><span class="s2">\&quot;, \&quot;</span><span class="nv">$CON2</span><span class="s2">\&quot;)&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;foreach (\$Connection in \$Connections) {&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot; \$CON = Get-AzVirtualNetworkGatewayConnection -name \$Connection -ResourceGroupName \$RSG&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;  Set-AzVirtualNetworkGatewayConnection -VirtualNetworkGatewayConnection \$CON -IpsecPolicies \$POLICY -UsePolicyBasedTrafficSelectors \$True -Force&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;}&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>

<span class="c1"># Generate ASA tunnel configuration</span>
<span class="k">for</span> i <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">OFFICES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  <span class="nv">OFFICE</span><span class="o">=</span><span class="nv">$i</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$OFFICE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;CPT&quot;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;03-4-tunnels-cpt-az</span><span class="nv">$REGION_PREFIX</span><span class="s2">&quot;</span>
    <span class="nv">PSK</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CPT_PSK</span><span class="s2">&quot;</span>
    <span class="nv">ASA_LOCAL_SUBNET</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$CPT_SUBNET</span><span class="s2">&quot;</span> <span class="p">|</span> grep -o <span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="k">)</span>
    <span class="nv">NEXT_HOP_INT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CPT_NEXT_HOP_INT</span><span class="s2">&quot;</span>
    <span class="nv">NEXT_HOP_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CPT_NEXT_HOP_IP</span><span class="s2">&quot;</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$OFFICE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;JHB&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;03-5-tunnels-jhb</span><span class="nv">$REGION_PREFIX</span><span class="s2">&quot;</span>
    <span class="nv">PSK</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$JHB_PSK</span><span class="s2">&quot;</span>
    <span class="nv">ASA_LOCAL_SUBNET</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$JHB_SUBNET</span><span class="s2">&quot;</span> <span class="p">|</span> grep -o <span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="k">)</span>
    <span class="nv">NEXT_HOP_INT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$JHB_NEXT_HOP_INT</span><span class="s2">&quot;</span>
    <span class="nv">NEXT_HOP_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$JHB_NEXT_HOP_IP</span><span class="s2">&quot;</span>
  <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$OFFICE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;DBN&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;03-6-tunnels-dbn</span><span class="nv">$REGION_PREFIX</span><span class="s2">&quot;</span>
    <span class="nv">PSK</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DBN_PSK</span><span class="s2">&quot;</span>
    <span class="nv">ASA_LOCAL_SUBNET</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$DBN_SUBNET</span><span class="s2">&quot;</span> <span class="p">|</span> grep -o <span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="k">)</span>
    <span class="nv">NEXT_HOP_INT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DBN_NEXT_HOP_INT</span><span class="s2">&quot;</span>
    <span class="nv">NEXT_HOP_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DBN_NEXT_HOP_IP</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
  <span class="nb">echo</span> <span class="s2">&quot;# This file is generated by scriptPX&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;wr mem&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;copy /noconfirm startup startup</span><span class="nv">$rdate</span><span class="s2">&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;name </span><span class="nv">$ASA_PEER</span><span class="s2"> </span><span class="nv">$ASA_PEER_NAME</span><span class="s2">&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;group-policy GroupPolicy_</span><span class="nv">$ASA_PEER</span><span class="s2"> internal&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;group-policy GroupPolicy_</span><span class="nv">$ASA_PEER</span><span class="s2"> attributes&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; vpn-tunnel-protocol ikev2&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;tunnel-group </span><span class="nv">$ASA_PEER</span><span class="s2"> type ipsec-l2l&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;tunnel-group </span><span class="nv">$ASA_PEER</span><span class="s2"> general-attributes&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; default-group-policy GroupPolicy_</span><span class="nv">$ASA_PEER</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;tunnel-group </span><span class="nv">$ASA_PEER</span><span class="s2"> ipsec-attributes&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; ikev2 local-authentication pre-shared-key </span><span class="nv">$PSK</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; ikev2 remote-authentication pre-shared-key </span><span class="nv">$PSK</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;object-group network VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; description OnPrem Network&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; network-object </span><span class="nv">$ASA_LOCAL_SUBNET</span><span class="s2"> 255.255.0.0&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;object-group network VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; description Azure Virtual Network&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; network-object </span><span class="nv">$ASA_REMOTE_SUBNET</span><span class="s2"> 255.255.0.0&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;access-list </span><span class="nv">$SUBNUM</span><span class="s2"> extended permit ip object-group VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2"> object-group VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto ikev2 policy </span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; encryption aes-</span><span class="nv">$P1_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; integrity sha</span><span class="nv">$P1_SHA</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; group </span><span class="nv">$DH_GROUP</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; prf </span><span class="nv">$PRF</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; lifetime seconds </span><span class="nv">$P1_LIFETIME</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto ipsec ikev2 ipsec-proposal AES-GCM-</span><span class="nv">$P2_GCM_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; protocol esp encryption aes-gcm-</span><span class="nv">$P2_GCM_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; protocol esp integrity aes-gcm-</span><span class="nv">$P2_GCM_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside_map </span><span class="nv">$SUBNUM</span><span class="s2"> match address </span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside_map </span><span class="nv">$SUBNUM</span><span class="s2"> set pfs group</span><span class="nv">$DH_GROUP</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside_map </span><span class="nv">$SUBNUM</span><span class="s2"> set peer </span><span class="nv">$ASA_PEER_NAME</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside_map </span><span class="nv">$SUBNUM</span><span class="s2"> set ikev2 ipsec-proposal AES-GCM-</span><span class="nv">$P2_GCM_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside2_map </span><span class="nv">$SUBNUM</span><span class="s2"> match address </span><span class="nv">$SUBNUM</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside2_map </span><span class="nv">$SUBNUM</span><span class="s2"> set pfs group</span><span class="nv">$DH_GROUP</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside2_map </span><span class="nv">$SUBNUM</span><span class="s2"> set peer </span><span class="nv">$ASA_PEER_NAME</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;crypto map outside2_map </span><span class="nv">$SUBNUM</span><span class="s2"> set ikev2 ipsec-proposal AES-GCM-</span><span class="nv">$P2_GCM_AES</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;nat (any,outside) source static VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2"> VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2"> destination static VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2"> VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2"> no-proxy-arp route-lookup&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;nat (any,outside2) source static VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2"> VPN-LOCAL-</span><span class="nv">$SUBNUM</span><span class="s2"> destination static VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2"> VPN-REMOTE-</span><span class="nv">$SUBNUM</span><span class="s2"> no-proxy-arp route-lookup&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;access-list Outside-Split-ACL standard permit </span><span class="nv">$ASA_REMOTE_SUBNET</span><span class="s2"> 255.255.0.0&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$NEXT_HOP_INT</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;outside&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;# using default route&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;route </span><span class="nv">$NEXT_HOP_INT</span><span class="s2"> </span><span class="nv">$ASA_PEER_NAME</span><span class="s2"> 255.255.255.255 </span><span class="nv">$NEXT_HOP_IP</span><span class="s2"> 1&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
  <span class="nb">echo</span> <span class="s2">&quot;wr mem&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$FILENAME</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
</div>
<div class="section" id="public-ip">
<h3>Public IP<a class="headerlink" href="#public-ip" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;code&gt;AZ_PEER_PIP1<span class="o">=</span><span class="k">$(</span>az network public-ip show -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VGW_PIP</span><span class="s2">&quot;</span> --query ipAddress -o tsv<span class="k">)</span>
</pre></div>
</div>
</div>
<div class="section" id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Nothing needs to be defined to use function (no, you don&#39;t have to define Nothing= :))</span>
network-lb-create<span class="o">()</span> <span class="o">{</span>
  az network lb create --resource-group <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --name <span class="s2">&quot;</span><span class="nv">$LB_NAME</span><span class="s2">&quot;</span> --frontend-ip-name <span class="s2">&quot;</span><span class="nv">$LB_FE_POOL_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --private-ip-address <span class="s2">&quot;</span><span class="nv">$LB_IP</span><span class="s2">&quot;</span> --backend-pool-name <span class="s2">&quot;</span><span class="nv">$LB_BE_POOL_NAME</span><span class="s2">&quot;</span> --vnet-name <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">&quot;</span> --subnet <span class="s2">&quot;</span><span class="nv">$SUBNET</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># LB_PROBE_PROTO and LB_PROBE_PORT need to be defined to use function</span>
network-lb-probe-create<span class="o">()</span> <span class="o">{</span>
  az network lb probe create --resource-group <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --lb-name <span class="s2">&quot;</span><span class="nv">$LB_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --name <span class="s2">&quot;</span><span class="nv">$LB_PROBE_NAME</span><span class="s2">&quot;</span> --protocol <span class="s2">&quot;</span><span class="nv">$LB_PROBE_PROTO</span><span class="s2">&quot;</span> --port <span class="s2">&quot;</span><span class="nv">$LB_PROBE_PORT</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># LB_RULE_NAME, LB_RULE_PORT, and LB_RULE_PROTO need to be defined to use function</span>
lb-rule-create<span class="o">()</span> <span class="o">{</span>
  az network lb rule create --resource-group <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --lb-name <span class="s2">&quot;</span><span class="nv">$LB_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
  --name <span class="s2">&quot;</span><span class="nv">$LB_NAME</span><span class="s2">-</span><span class="nv">$LB_RULE_NAME</span><span class="s2">&quot;</span> --protocol <span class="s2">&quot;</span><span class="nv">$LB_RULE_PROTO</span><span class="s2">&quot;</span> --frontend-port <span class="s2">&quot;</span><span class="nv">$LB_RULE_PORT</span><span class="s2">&quot;</span> <span class="se">\</span>
  --backend-port <span class="s2">&quot;</span><span class="nv">$LB_RULE_PORT</span><span class="s2">&quot;</span> --frontend-ip-name <span class="s2">&quot;</span><span class="nv">$LB_FE_POOL_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
  --backend-pool-name <span class="s2">&quot;</span><span class="nv">$LB_BE_POOL_NAME</span><span class="s2">&quot;</span> --probe-name <span class="s2">&quot;</span><span class="nv">$LB_PROBE_NAME</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># NSGR_NAME, NSGR_SRC, NSGR_DST, NSGR_PORTS, NSGR_PROTO, and NSGR_PRIORITY need to be defined to use function</span>
nsg-rule-create<span class="o">()</span> <span class="o">{</span>
  az network nsg rule create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --nsg-name <span class="s2">&quot;</span><span class="nv">$NSG</span><span class="s2">&quot;</span> -n <span class="nv">$NSGR_NAME</span> <span class="se">\</span>
    --source-address-prefixes <span class="s2">&quot;&quot;</span><span class="nv">$NSGR_SRC</span><span class="s2">&quot;&quot;</span> <span class="se">\</span>
    --destination-address-prefixes <span class="s2">&quot;</span><span class="nv">$NSGR_DST</span><span class="s2">&quot;</span>  <span class="se">\</span>
    --destination-port-ranges <span class="s2">&quot;</span><span class="nv">$NSGR_PORTS</span><span class="s2">&quot;</span> --priority <span class="s2">&quot;</span><span class="nv">$NSGR_PRIORITY</span><span class="s2">&quot;</span> <span class="se">\</span>
    --access Allow --protocol <span class="s2">&quot;</span><span class="nv">$NSGR_PROTO</span><span class="s2">&quot;</span> --direction Inbound
<span class="o">}</span>

<span class="c1"># VM_NIC_NAME needs to be defined to use function</span>
network-nic-create<span class="o">()</span> <span class="o">{</span>
  az network nic create <span class="se">\</span>
    -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VM_NIC_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --vnet-name <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">&quot;</span> <span class="se">\</span>
    --subnet <span class="s2">&quot;</span><span class="nv">$SUBNET</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>

network-nic-list<span class="o">()</span> <span class="o">{</span>
  az network nic list <span class="se">\</span>
    -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> <span class="se">\</span>
    --vnet-name <span class="s2">&quot;</span><span class="nv">$VNET</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># AS_NAME needs to be defined to use function</span>
vm-availability-set-create<span class="o">()</span> <span class="o">{</span>
  az vm availability-set create -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$AS_NAME</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># VM_NIC_NAME needs to be defined to use function</span>
network-nic-pool-add<span class="o">()</span> <span class="o">{</span>
  az network nic ip-config address-pool add -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> --nic-name <span class="s2">&quot;</span><span class="nv">$VM_NIC_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --ip-config-name <span class="s2">&quot;ipconfig1&quot;</span> --address-pool <span class="s2">&quot;</span><span class="nv">$LB_BE_POOL_NAME</span><span class="s2">&quot;</span> --lb-name <span class="s2">&quot;</span><span class="nv">$LB_NAME</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># VM_NAME and VM_NIC_NAME need to be defined to use function</span>
vm-create<span class="o">()</span> <span class="o">{</span>
  az vm create <span class="se">\</span>
    -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VM_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --image <span class="s2">&quot;</span><span class="nv">$VM_IMAGE</span><span class="s2">&quot;</span> <span class="se">\</span>
    --admin-username <span class="s2">&quot;</span><span class="nv">$VM_USER</span><span class="s2">&quot;</span> <span class="se">\</span>
    --admin-password <span class="s2">&quot;</span><span class="nv">$VM_PASS</span><span class="s2">&quot;</span> <span class="se">\</span>
    --size <span class="s2">&quot;</span><span class="nv">$VM_FLAVOUR</span><span class="s2">&quot;</span> <span class="se">\</span>
    --storage-sku <span class="s2">&quot;</span><span class="nv">$VM_DISK_TYPE</span><span class="s2">&quot;</span> <span class="se">\</span>
    --nics <span class="s2">&quot;</span><span class="nv">$VM_NIC_NAME</span><span class="s2">&quot;</span> <span class="se">\</span>
    --generate-ssh-keys <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># VM_NAME needs to be defined to use function</span>
vm-ip-private<span class="o">()</span> <span class="o">{</span>
  az vm show -d -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VM_NAME</span><span class="s2">&quot;</span> --query privateIps -o tsv
<span class="o">}</span>

<span class="c1"># VM_NAME needs to be defined to use function</span>
vm-ip-public<span class="o">()</span> <span class="o">{</span>
  az vm show -d -g <span class="s2">&quot;</span><span class="nv">$RSG</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="nv">$VM_NAME</span><span class="s2">&quot;</span> --query publicIps -o tsv
<span class="o">}</span>

<span class="c1"># VM_IP needs to be defined to use function</span>
vm-copy-ssh-key<span class="o">()</span> <span class="o">{</span>
  .ssh/login.expect <span class="s2">&quot;</span><span class="nv">$VM_PASS</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$VM_USER</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$VM_IP</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="resize-disk">
<h3>Resize Disk<a class="headerlink" href="#resize-disk" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/expand-disks">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/expand-disks</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a list of disks in RSG</span>
az disk list -g RSG --query <span class="s1">&#39;[*].{Name:name,Gb:diskSizeGb,Tier:accountType}&#39;</span> --output table

<span class="c1"># Output the name of the disk</span>
az disk list -g RSG --query <span class="s1">&#39;[*].{Name:name,Gb:diskSizeGb,Tier:accountType}&#39;</span> --output table <span class="p">|</span> grep SERVERNAME <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span>

<span class="c1"># Stop the VM</span>
az vm stop -g RSG -n SERVERNAME

<span class="c1"># Deallocate the VM</span>
az vm deallocate -g RSG -n SERVERNAME

<span class="c1"># Resize the disk</span>
az disk update -g UK-RSG -n SERVERNAME_OsDisk_1_xxxxxxxxxx --size-gb <span class="m">100</span>

<span class="c1"># Start the VM</span>
az vm start -g RSG -n SERVERNAME
</pre></div>
</div>
</div>
</div>
<div class="section" id="azure-powershell">
<h2>Azure Powershell<a class="headerlink" href="#azure-powershell" title="Permalink to this headline">¶</a></h2>
<div class="section" id="modifying-ipsec-policies">
<h3>Modifying IPSec Policies<a class="headerlink" href="#modifying-ipsec-policies" title="Permalink to this headline">¶</a></h3>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Maximum strength:</span>

<span class="nv">$POLICY</span> <span class="p">=</span> <span class="nb">New-AzIpsecPolicy</span> <span class="n">-IkeEncryption</span> <span class="n">AES256</span> <span class="n">-IkeIntegrity</span> <span class="n">SHA384</span> <span class="n">-DhGroup</span> <span class="n">DHGroup24</span> <span class="n">-IpsecEncryption</span> <span class="n">GCMAES256</span> <span class="n">-IpsecIntegrity</span> <span class="n">GCMAES256</span> <span class="n">-PfsGroup</span> <span class="n">PFS24</span> <span class="n">-SALifeTimeSeconds</span> <span class="n">14400</span> <span class="n">-SADataSizeKilobytes</span> <span class="n">102400000</span>
<span class="nv">$RSG</span> <span class="p">=</span> <span class="s2">&quot;RSG&quot;</span>
<span class="nv">$Connections</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;CON1&quot;</span><span class="p">,</span> <span class="s2">&quot;CON2&quot;</span><span class="p">)</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$Connection</span> <span class="k">in</span> <span class="nv">$Connections</span><span class="p">)</span> <span class="p">{</span>
 <span class="nv">$CON</span> <span class="p">=</span> <span class="nb">Get-AzVirtualNetworkGatewayConnection</span> <span class="n">-name</span> <span class="nv">$Connection</span> <span class="n">-ResourceGroupName</span> <span class="nv">$RSG</span>
  <span class="nb">Set-AzVirtualNetworkGatewayConnection</span> <span class="n">-VirtualNetworkGatewayConnection</span> <span class="nv">$CON</span> <span class="n">-IpsecPolicies</span> <span class="nv">$POLICY</span> <span class="n">-UsePolicyBasedTrafficSelectors</span> <span class="nv">$True</span> <span class="n">-Force</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-aadds">
<h3>Deploy AADDS<a class="headerlink" href="#deploy-aadds" title="Permalink to this headline">¶</a></h3>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Change the following values to match your deployment.</span>
<span class="nv">$AaddsAdminUserUpn</span> <span class="p">=</span> <span class="s2">&quot;admin@contoso.onmicrosoft.com&quot;</span>
<span class="nv">$ResourceGroupName</span> <span class="p">=</span> <span class="s2">&quot;myResourceGroup&quot;</span>
<span class="nv">$VnetName</span> <span class="p">=</span> <span class="s2">&quot;myVnet&quot;</span>
<span class="nv">$AzureLocation</span> <span class="p">=</span> <span class="s2">&quot;westus&quot;</span>
<span class="nv">$AzureSubscriptionId</span> <span class="p">=</span> <span class="s2">&quot;xxxxxx-xxxxx-xxxx-xxxx-xxxxxxx&quot;</span>
<span class="nv">$ManagedDomainName</span> <span class="p">=</span> <span class="s2">&quot;mydomain.com&quot;</span>

<span class="c"># Connect to your Azure AD directory.</span>
<span class="nb">Connect-AzureAD</span>

<span class="c"># Login to your Azure subscription.</span>
<span class="nb">Connect-AzAccount</span>

<span class="c"># Create the service principal for Azure AD Domain Services.</span>
<span class="nb">New-AzureADServicePrincipal</span> <span class="n">-AppId</span> <span class="s2">&quot;2565bd9d-da50-47d4-8b85-4c97f669dc36&quot;</span>

<span class="c"># Create the delegated administration group for AAD Domain Services.</span>
<span class="nb">New-AzureADGroup</span> <span class="n">-DisplayName</span> <span class="s2">&quot;AAD DC Administrators&quot;</span> <span class="p">`</span>
  <span class="n">-Description</span> <span class="s2">&quot;Delegated group to administer Azure AD Domain Services&quot;</span> <span class="p">`</span>
  <span class="n">-SecurityEnabled</span> <span class="nv">$true</span> <span class="n">-MailEnabled</span> <span class="nv">$false</span> <span class="p">`</span>
  <span class="n">-MailNickName</span> <span class="s2">&quot;AADDCAdministrators&quot;</span>

<span class="c"># First, retrieve the object ID of the newly created &#39;AAD DC Administrators&#39; group.</span>
<span class="nv">$GroupObjectId</span> <span class="p">=</span> <span class="nb">Get-AzureADGroup</span> <span class="p">`</span>
  <span class="n">-Filter</span> <span class="s2">&quot;DisplayName eq &#39;AAD DC Administrators&#39;&quot;</span> <span class="p">|</span> <span class="p">`</span>
  <span class="nb">Select-Object</span> <span class="n">ObjectId</span>

<span class="c"># Now, retrieve the object ID of the user you&#39;d like to add to the group.</span>
<span class="nv">$UserObjectId</span> <span class="p">=</span> <span class="nb">Get-AzureADUser</span> <span class="p">`</span>
  <span class="n">-Filter</span> <span class="s2">&quot;UserPrincipalName eq &#39;$AaddsAdminUserUpn&#39;&quot;</span> <span class="p">|</span> <span class="p">`</span>
  <span class="nb">Select-Object</span> <span class="n">ObjectId</span>

<span class="c"># Add the user to the &#39;AAD DC Administrators&#39; group.</span>
<span class="nb">Add-AzureADGroupMember</span> <span class="n">-ObjectId</span> <span class="nv">$GroupObjectId</span><span class="p">.</span><span class="n">ObjectId</span> <span class="n">-RefObjectId</span> <span class="nv">$UserObjectId</span><span class="p">.</span><span class="n">ObjectId</span>

<span class="c"># Register the resource provider for Azure AD Domain Services with Resource Manager.</span>
<span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AAD</span>

<span class="c"># Create the resource group.</span>
<span class="nb">New-AzResourceGroup</span> <span class="p">`</span>
  <span class="n">-Name</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
  <span class="n">-Location</span> <span class="nv">$AzureLocation</span>

<span class="c"># Create the dedicated subnet for AAD Domain Services.</span>
<span class="nv">$AaddsSubnet</span> <span class="p">=</span> <span class="nb">New-AzVirtualNetworkSubnetConfig</span> <span class="p">`</span>
  <span class="n">-Name</span> <span class="n">DomainServices</span> <span class="p">`</span>
  <span class="n">-AddressPrefix</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>

<span class="nv">$WorkloadSubnet</span> <span class="p">=</span> <span class="nb">New-AzVirtualNetworkSubnetConfig</span> <span class="p">`</span>
  <span class="n">-Name</span> <span class="n">Workloads</span> <span class="p">`</span>
  <span class="n">-AddressPrefix</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>

<span class="c"># Create the virtual network in which you will enable Azure AD Domain Services.</span>
<span class="nv">$Vnet</span><span class="p">=</span><span class="nb">New-AzVirtualNetwork</span> <span class="p">`</span>
  <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
  <span class="n">-Location</span> <span class="nv">$AzureLocation</span> <span class="p">`</span>
  <span class="n">-Name</span> <span class="nv">$VnetName</span> <span class="p">`</span>
  <span class="n">-AddressPrefix</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span> <span class="p">`</span>
  <span class="n">-Subnet</span> <span class="nv">$AaddsSubnet</span><span class="p">,</span><span class="nv">$WorkloadSubnet</span>

<span class="c"># Enable Azure AD Domain Services for the directory.</span>
<span class="nb">New-AzResource</span> <span class="n">-ResourceId</span> <span class="s2">&quot;/subscriptions/$AzureSubscriptionId/resourceGroups/$ResourceGroupName/providers/Microsoft.AAD/DomainServices/$ManagedDomainName&quot;</span> <span class="p">`</span>
  <span class="n">-Location</span> <span class="nv">$AzureLocation</span> <span class="p">`</span>
  <span class="n">-Properties</span> <span class="p">@{</span><span class="s2">&quot;DomainName&quot;</span><span class="p">=</span><span class="nv">$ManagedDomainName</span><span class="p">;</span> <span class="p">`</span>
    <span class="s2">&quot;SubnetId&quot;</span><span class="p">=</span><span class="s2">&quot;/subscriptions/$AzureSubscriptionId/resourceGroups/$ResourceGroupName/providers/Microsoft.Network/virtualNetworks/$VnetName/subnets/DomainServices&quot;</span><span class="p">}</span> <span class="p">`</span>
  <span class="n">-Force</span> <span class="n">-Verbose</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="connection-troubleshooting">
<h2>Connection Troubleshooting<a class="headerlink" href="#connection-troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="gui">
<h3>GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-packet-capture-manage-portal">https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-packet-capture-manage-portal</a></p>
<p><strong>Create a Storage Account</strong></p>
<img alt="../../_images/azure-connection-troubleshooting-1.png" src="../../_images/azure-connection-troubleshooting-1.png" />
<p>Go to Home &gt; <a class="reference external" href="https://portal.azure.com/#blade/Microsoft_Azure_Network/NetworkWatcherMenuBlade/packetCapture">Network Watcher - Packet capture</a> &gt; Add</p>
<img alt="../../_images/azure-connection-troubleshooting-1.png" src="../../_images/azure-connection-troubleshooting-1.png" />
<p>Select the following from the dropdowns:</p>
<ul class="simple">
<li><p>Resource group: (your RSG)</p></li>
<li><p>Target Virtual Machine: (the VM that you want to run the capture on)</p></li>
<li><p>Packet capture name: (give it something unique)</p></li>
<li><p>Storage account: (your storage account )</p></li>
<li><p>Maximum bytes per session: 10485760 (10MB, instead of the default 1GB)</p></li>
</ul>
<img alt="../../_images/azure-connection-troubleshooting-1.png" src="../../_images/azure-connection-troubleshooting-1.png" />
</div>
<div class="section" id="cli">
<h3>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-packet-capture-manage-powershell">https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-packet-capture-manage-powershell</a></p>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/network/watcher/packet-capture?view=azure-cli-latest">https://docs.microsoft.com/en-us/cli/azure/network/watcher/packet-capture?view=azure-cli-latest</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az network watcher packet-capture create -g MyResourceGroup -n MyPacketCaptureName --vm MyVm <span class="se">\</span>
                          --storage-account MyStorageAccount --filters <span class="s1">&#39;[ \</span>
<span class="s1">                              { \</span>
<span class="s1">                                  &quot;protocol&quot;:&quot;TCP&quot;, \</span>
<span class="s1">                                  &quot;remoteIPAddress&quot;:&quot;1.1.1.1-255.255.255&quot;, \</span>
<span class="s1">                                  &quot;localIPAddress&quot;:&quot;10.0.0.3&quot;, \</span>
<span class="s1">                                  &quot;remotePort&quot;:&quot;20&quot; \</span>
<span class="s1">                              }, \</span>
<span class="s1">                              { \</span>
<span class="s1">                                  &quot;protocol&quot;:&quot;TCP&quot;, \</span>
<span class="s1">                                  &quot;remoteIPAddress&quot;:&quot;1.1.1.1-255.255.255&quot;, \</span>
<span class="s1">                                  &quot;localIPAddress&quot;:&quot;10.0.0.3&quot;, \</span>
<span class="s1">                                  &quot;remotePort&quot;:&quot;80&quot; \</span>
<span class="s1">                              }, \</span>
<span class="s1">                              { \</span>
<span class="s1">                                  &quot;protocol&quot;:&quot;TCP&quot;, \</span>
<span class="s1">                                  &quot;remoteIPAddress&quot;:&quot;1.1.1.1-255.255.255&quot;, \</span>
<span class="s1">                                  &quot;localIPAddress&quot;:&quot;10.0.0.3&quot;, \</span>
<span class="s1">                                  &quot;remotePort&quot;:&quot;443&quot; \</span>
<span class="s1">                              }, \</span>
<span class="s1">                              { \</span>
<span class="s1">                                  &quot;protocol&quot;:&quot;UDP&quot; \</span>
<span class="s1">                              }]&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="cloudflare.html" class="btn btn-neutral float-right" title="Cloudflare" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Cloud" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Caleb Sargeant.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>