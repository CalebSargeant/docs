

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Hyper-V &mdash; Caleb Sargeant&#39;s Docs 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PowerShell" href="powershell.html" />
    <link rel="prev" title="Group Policy" href="group-policy.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Caleb Sargeant's Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../networking/cisco/index.html">Cisco</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/fortigate.html">FortiGate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/hp.html">HP Procurve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/juniper.html">Juniper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/ubiquiti-unifi.html">Ubiquiti UniFi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/netdevops-toolchest.html">NetDevOps Tool Chest</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Computing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ansible/index.html">Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bamboo.html">Bamboo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/index.html">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../containerisation/index.html">Containerisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jenkins/index.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terraform/index.html">Terraform</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Microsoft</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="general.html">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="group-policy.html">Group Policy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Hyper-V</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-snapshot">Creating a Snapshot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vm-failover">VM Failover</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#certificate-installation">Certificate Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-replication">Enabling Replication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#failing-over">Failing Over</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="powershell.html">PowerShell</a></li>
<li class="toctree-l2"><a class="reference internal" href="robocopy.html">Robocopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="sendkeys.html">Sendkeys</a></li>
<li class="toctree-l2"><a class="reference internal" href="unattended.html">Unattended Installations</a></li>
<li class="toctree-l2"><a class="reference internal" href="server/index.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="exchange/index.html">Exchange</a></li>
<li class="toctree-l2"><a class="reference internal" href="sharepoint/index.html">SharePoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="sql-server/index.html">SQL Server</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../programming/bash.html">Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming/python/index.html">Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../other/api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/general/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/iperf.html">iPerf3</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Caleb Sargeant's Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Microsoft</a> &raquo;</li>
        
      <li>Hyper-V</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/computing/microsoft/hyperv.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hyper-v">
<h1>Hyper-V<a class="headerlink" href="#hyper-v" title="Permalink to this headline">¶</a></h1>
<div class="section" id="creating-a-snapshot">
<h2>Creating a Snapshot<a class="headerlink" href="#creating-a-snapshot" title="Permalink to this headline">¶</a></h2>
<p>A very duh thing to add, but anyway:</p>
<p>Go to <em>Hyper-V Manager</em>, right click on the VM, click on <em>Checkpoint</em>.</p>
<img alt="../../_images/hyperv-checkpoint-1.png" src="../../_images/hyperv-checkpoint-1.png" />
</div>
<div class="section" id="vm-failover">
<h2>VM Failover<a class="headerlink" href="#vm-failover" title="Permalink to this headline">¶</a></h2>
<div class="section" id="certificate-installation">
<h3>Certificate Installation<a class="headerlink" href="#certificate-installation" title="Permalink to this headline">¶</a></h3>
<p>This should already be in place, however, if you are receiving errors, you can set up the connection between the hypervisors again. In the below code, we are creating certificates for HYPERVISOR-02 and HYPERVISOR-01, so that we can enable replication between the two. The below certificates are computer-based certificates.</p>
<p>Generating the Root Certificate</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">New-SelfSignedCertificate</span> <span class="n">-Type</span> <span class="s2">&quot;Custom&quot;</span> <span class="n">-KeyExportPolicy</span> <span class="s2">&quot;Exportable&quot;</span> <span class="n">-Subject</span> <span class="s2">&quot;CN=HYPERVISOR-01_to_HYPERVISOR-02-Replication&quot;</span> <span class="n">-CertStoreLocation</span> <span class="s2">&quot;Cert:\LocalMachine\My&quot;</span> <span class="n">-KeySpec</span> <span class="s2">&quot;Signature&quot;</span> <span class="n">-KeyUsage</span> <span class="s2">&quot;CertSign&quot;</span> <span class="n">-NotAfter</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddYears</span><span class="p">(</span><span class="n">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Generating the Cert for HYPERVISOR-02</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">New-SelfSignedCertificate</span> <span class="n">-type</span> <span class="s2">&quot;Custom&quot;</span> <span class="n">-KeyExportPolicy</span> <span class="s2">&quot;Exportable&quot;</span> <span class="n">-Subject</span> <span class="s2">&quot;CN=HYPERVISOR-01&quot;</span> <span class="n">-CertStoreLocation</span> <span class="s2">&quot;Cert:\LocalMachine\My&quot;</span> <span class="n">-KeySpec</span> <span class="s2">&quot;KeyExchange&quot;</span> <span class="n">-TextExtension</span> <span class="p">@(</span><span class="s2">&quot;2.5.29.37={text}1.3.6.1.5.5.7.3.1,1.3.6.1.5.5.7.3.2&quot;</span><span class="p">)</span> <span class="n">-Signer</span> <span class="s2">&quot;Cert:LocalMachine\My\6C435EE329087825553189D38CD29BEC9E124AB0&quot;</span> <span class="n">-Provider</span> <span class="s2">&quot;Microsoft Enhanced RSA and AES Cryptographic Provider&quot;</span> <span class="n">-NotAfter</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddYears</span><span class="p">(</span><span class="n">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Generating the Cert for HYPERVISOR-01</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">New-SelfSignedCertificate</span> <span class="n">-Type</span> <span class="s2">&quot;Custom&quot;</span> <span class="n">-KeyExportPolicy</span> <span class="s2">&quot;Exportable&quot;</span> <span class="n">-Subject</span> <span class="s2">&quot;CN=HYPERVISOR-01_to_HYPERVISOR-02-Replication&quot;</span> <span class="n">-CertStoreLocation</span> <span class="s2">&quot;Cert:\LocalMachine\My&quot;</span> <span class="n">-KeySpec</span> <span class="s2">&quot;Signature&quot;</span> <span class="n">-KeyUsage</span> <span class="s2">&quot;CertSign&quot;</span> <span class="n">-NotAfter</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddYears</span><span class="p">(</span><span class="n">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Place this certificate on both hosts in the Personal store.</p>
<p>Copy the certificates to the other hypervisor and import the certificates. Note that the root certificate needs to be in the Trusted Root Certification Authorities store and the other certificates need to be in the Personal store.</p>
<p>Disable Certificate Revocation Check on the hypervisor, as the certificates are self-signed.</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>REG ADD <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization\Replication&quot;</span> /v DisableCertRevocationCheck /d 1 /t REG_DWORD /f
</pre></div>
</div>
</div>
<div class="section" id="enabling-replication">
<h3>Enabling Replication<a class="headerlink" href="#enabling-replication" title="Permalink to this headline">¶</a></h3>
<p id="id1">Right click on the Virtual Machine and click on <em>Enable Replication…</em></p>
<img alt="../../_images/hyperv-replication-1.png" src="../../_images/hyperv-replication-1.png" />
<p>Specify the Replica Server</p>
<img alt="../../_images/hyperv-replication-2.png" src="../../_images/hyperv-replication-2.png" />
<p>Specify the Connection Parameters. Select the imported certificate.</p>
<img alt="../../_images/hyperv-replication-3.png" src="../../_images/hyperv-replication-3.png" />
<p>Accept the defaults and Finish</p>
<img alt="../../_images/hyperv-replication-4.png" src="../../_images/hyperv-replication-4.png" />
</div>
<div class="section" id="failing-over">
<h3>Failing Over<a class="headerlink" href="#failing-over" title="Permalink to this headline">¶</a></h3>
<p>There are two types of Failovers, as described below.</p>
<p><strong>Planned Failover</strong></p>
<p>A Planned Failover is when the <em>Primary Virtual Machine</em> is still online and active, and you would like to make the other hypervisor the host for the virtual machine, or you would like to test that the failover would work.</p>
<p>Executing a Planned Failover</p>
<p>Power down the Virtual Machine, so that you can failover.</p>
<p>On the primary host, right click on the Virtual Machine and click on <em>Replication &gt; Planned Failover…</em></p>
<img alt="../../_images/hyperv-replication-5.png" src="../../_images/hyperv-replication-5.png" />
<p>Leave the <em>Reverse the replication direction after failover</em> unchecked, because you will receive the below error.</p>
<img alt="../../_images/hyperv-replication-6.png" src="../../_images/hyperv-replication-6.png" />
<p>Instead, ensure that only <em>Start the Replica virtual machine after failover</em> is checked. Click on <em>Fail Over</em>.</p>
<img alt="../../_images/hyperv-replication-7.png" src="../../_images/hyperv-replication-7.png" />
<p>On the secondary host (note that the VM on this host is still the <em>Replica</em> or secondary), right click on the Virtual Machine and click on <em>Replication &gt; Failover…</em> This is to complete the failover process.</p>
<img alt="../../_images/hyperv-replication-8.png" src="../../_images/hyperv-replication-8.png" />
<p>This time you can check both boxes. This will make the secondary host primary, by designating the <em>Replica</em> as the <em>Primary</em> and vice versa. If you leave the <em>Reverse the replication direction after failover</em> checkbox unchecked, you will have to go through the <em>Reverse Replication Wizard *(right click on the *VM &gt; Replication &gt; Reverse Replication…</em>), which is similar to :<a class="reference internal" href="#id1"><span class="std std-ref">Enabling Replication</span></a>. You would leave it unchecked if you want to keep the roles of the VMs the same (<em>Primary</em> as Primary and <em>Replica</em> as <em>Replica</em>). It is to be noted that to get the VM running on the old primary host again (in this case HYPERVISOR-01), you will need to reverse replication. It is, therefore, recommended that you check both boxes. <em>Reverse Replication</em> basically switches the roles around.</p>
<img alt="../../_images/hyperv-replication-9.png" src="../../_images/hyperv-replication-9.png" />
<p><strong>Unplanned Failover</strong></p>
<p>An unplanned failover is when the hypervisor hosting the <em>Primary</em> Virtual Machine becomes unreachable (due to power failure, natural disaster, etc), and you would like to start the <em>Replica</em> Virtual Machine to keep the services that the server was running online. An unplanned failover assumes that the primary host is unrecoverable and that the <em>Primary</em> Virtual Machine is lost completely.</p>
<p>Executing an Unplanned Failover</p>
<p>Right click on the <em>Replica</em> Virtual Machine, click on <em>Replication &gt; Failover…</em></p>
<img alt="../../_images/hyperv-replication-10.png" src="../../_images/hyperv-replication-10.png" />
<p>Read the screen, as it mentions the difference between planned and unplanned failover. Select your recovery point (usually the latest). Click on <em>Fail Over</em>.</p>
<img alt="../../_images/hyperv-replication-11.png" src="../../_images/hyperv-replication-11.png" />
<p><strong>Post Failover Steps</strong></p>
<p>When the VM has been moved to the secondary host, you will need to change its IP Address (if static) and change the DNS record accordingly.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="powershell.html" class="btn btn-neutral float-right" title="PowerShell" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="group-policy.html" class="btn btn-neutral float-left" title="Group Policy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Caleb Sargeant.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>