

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Nagios &mdash; Caleb Sargeant&#39;s Docs 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Networking" href="networking.html" />
    <link rel="prev" title="Monitoring" href="monitoring.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Caleb Sargeant's Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../networking/security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/cisco/index.html">Cisco</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/fortigate.html">FortiGate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/hp.html">HP Procurve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/juniper.html">Juniper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/ubiquiti-unifi.html">Ubiquiti UniFi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/netdevops-toolchest.html">NetDevOps Tool Chest</a></li>
</ul>
<p class="caption"><span class="caption-text">Computing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ansible/index.html">Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/index.html">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../containerisation/index.html">Containerisation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bash.html">Bash</a></li>
<li class="toctree-l2"><a class="reference internal" href="databases.html">Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="general.html">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="kvm.html">KVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Nagios</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-linux-hosts">Adding Linux Hosts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#on-the-nagios-box">On the Nagios Box</a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-the-host-to-monitor">On the host to monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="raspberry.html">Raspberry Pi</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../microsoft/index.html">Microsoft</a></li>
</ul>
<p class="caption"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../other/api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/general/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/iperf.html">iPerf3</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Caleb Sargeant's Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Linux</a> &raquo;</li>
        
      <li>Nagios</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/computing/linux/nagios.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nagios">
<h1>Nagios<a class="headerlink" href="#nagios" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="adding-linux-hosts">
<h1>Adding Linux Hosts<a class="headerlink" href="#adding-linux-hosts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="on-the-nagios-box">
<h2>On the Nagios Box<a class="headerlink" href="#on-the-nagios-box" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the host in config (see below example config file)</span>
nano /etc/nagios3/conf.d/server.fqdn.com.cfg

<span class="c1"># ALWAYS verify Nagios config before reloading service, ensure that there are no errors (warnings are okay)</span>
<span class="nb">cd</span> /etc/nagios3/
nagios3 -v nagios.cfg

<span class="c1"># If no errors, you should be safe to reload nagios service (DO NOT restart service)</span>
/etc/init.d/nagios3 reload
</pre></div>
</div>
<p><strong>Example config file</strong> (the last service is a custom service check example):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>define host <span class="o">{</span>
    address                        server.example.com
    <span class="nb">alias</span>                          server.example.com
    check_command                  check_ping!100.0,20%!500.0,60%
    host_name                      server.example.com
    hostgroups                     ubuntu_hosts
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    use                            generic-host
<span class="o">}</span>
define hostextinfo <span class="o">{</span>
    host_name                      server.example.com
    icon_image                     base/ubuntu.png
    icon_image_alt                 Ubuntu
    statusmap_image                base/ubuntu.gd2
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_load
    display_name                   CPU Load
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            CPU Load
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_mem
    display_name                   Memory
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Memory
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_vda1
    display_name                   Disk Status
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Disk vda1 Status
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_tcp!22
    display_name                   SSH/sftp Port <span class="m">22</span>
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            SSH/sftp Port <span class="m">22</span>
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_total_procs
    display_name                   Total Procs
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Total Procs
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_users
    display_name                   User Check
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Users Check
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_zombie_procs
    display_name                   Zombie Procs
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Zombie Procs
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_OpManager
    display_name                   Netflow Service
    host_name                      server.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            Netflow Service Status
    use                            generic-service
<span class="o">}</span>
define service <span class="o">{</span>
    check_command                  check_nrpe!check_mysql
    display_name                   MySQL Status
    host_name                      nagiosserver.example.com
    max_check_attempts             <span class="m">3</span>
    notification_period            24x7
    service_description            MySQL Status
    use                            generic-service
<span class="o">}</span>
</pre></div>
</div>
<p><strong>In the GUI:</strong></p>
<p>After adding the host and reloading the Nagios service, quickly go to the Nagios GUI and mute the notifications. You can also schedule a check to re-check the host’s service statuses (almost) immediately, view the status detail for the host (list of items Nagios is monitoring), etc.</p>
<img alt="../../_images/nagios-1.png" src="../../_images/nagios-1.png" />
</div>
<div class="section" id="on-the-host-to-monitor">
<h2>On the host to monitor<a class="headerlink" href="#on-the-host-to-monitor" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># See if Nagios is already installed</span>
dpkg -l <span class="p">|</span> grep nagios

<span class="c1"># Install Nagios</span>
apt-get install nagios-nrpe-server nagios-plugins-basic

<span class="c1"># Add your custom checks (see below custom_nrpe.cfg file)</span>
nano /etc/nagios/nrpe.d/custom_nrpe.cfg

<span class="c1"># Create the check_mem plugin, as it&#39;s a custom, standard check (see below check_mem file)</span>
nano /usr/lib/nagios/plugins/check_mem

<span class="c1"># Make the file executable</span>
chmod +x /usr/lib/nagios/plugins/check_mem

<span class="c1"># Add x.x.x.x (servername) to the allowed hosts (you will get &quot;CHECK_NRPE: Error - Could not complete SSL handshake.&quot; in Nagios GUI if you don&#39;t add this line)</span>
nano /etc/nagios/nrpe.cfg
    <span class="nv">allowed_hosts</span><span class="o">=</span><span class="m">127</span>.0.0.1,x.x.x.x

<span class="c1"># Restart the nagios-nrpe-server for it to recognise the change</span>
/etc/init.d/nagios-nrpe-server restart
</pre></div>
</div>
<p><strong>File custom_nrpe.cfg</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">##########################################################</span>
<span class="c1">#                                                        #</span>
<span class="c1">#   you can place all you custom-config snipplets here   #</span>
<span class="c1">#   only snipplets ending in .cfg will get included      #</span>
<span class="c1">#                                                        #</span>
<span class="c1">##########################################################</span>
<span class="c1">#</span>
<span class="c1"># Generic Checks - For all nodes</span>
command<span class="o">[</span>check_zombie_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -w <span class="m">5</span> -c <span class="m">10</span> -s Z
command<span class="o">[</span>check_total_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -w <span class="m">600</span> -c <span class="m">800</span>
command<span class="o">[</span>check_vda1<span class="o">]=</span>/usr/lib/nagios/plugins/check_disk -w <span class="m">10</span>% -c <span class="m">5</span>% -x tmpfs -x udev -x /snap/*
command<span class="o">[</span>check_disk_inode<span class="o">]=</span>/usr/lib/nagios/plugins/check_disk_inodes -w <span class="m">80</span> -c <span class="m">90</span> -p /
command<span class="o">[</span>check_running_proc<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs <span class="nv">$ARG1</span>$
command<span class="o">[</span>check_puppet_agent<span class="o">]=</span>sudo /usr/lib/nagios/plugins/check_puppet_agent
command<span class="o">[</span>check_open_deleted_files<span class="o">]=</span>sudo /usr/lib/nagios/plugins/check_open_deleted_files -w <span class="m">15000000000</span> -c <span class="m">20000000000</span>
command<span class="o">[</span>check_kernel<span class="o">]=</span>sudo /usr/lib/nagios/plugins/check_kernel
command<span class="o">[</span>check_users<span class="o">]=</span>/usr/lib/nagios/plugins/check_users -w <span class="m">10</span> -c <span class="m">20</span>
command<span class="o">[</span>check_sssd_status<span class="o">]=</span>/usr/lib/nagios/plugins/check_sssd_status
command<span class="o">[</span>check_java_version<span class="o">]=</span>/usr/lib/nagios/plugins/check_java_version

<span class="c1"># Check Load - Defined per node type</span>
<span class="c1">##command[check_load]=/usr/lib/nagios/plugins/check_load -w 15.0,10,5 -c 30,25,20</span>
<span class="c1">#</span>
command<span class="o">[</span>check_load<span class="o">]=</span>/usr/lib/nagios/plugins/check_load -r -w <span class="m">2</span>.5,2,1.5 -c <span class="m">4</span>,3.5,3



<span class="c1"># Check Load - Defined per node type</span>
command<span class="o">[</span>check_mem<span class="o">]=</span>/usr/lib/nagios/plugins/check_mem -w <span class="m">85</span> -c <span class="m">95</span>

<span class="c1"># KONG Checks</span>
command<span class="o">[</span>check_kong<span class="o">]=</span>/usr/lib/nagios/plugins/check_kong

<span class="c1"># ntpd Checks</span>
command<span class="o">[</span>check_ntpd<span class="o">]=</span>/usr/lib/nagios/plugins/check_ntpd --peer_warning <span class="m">1</span> --peer_critical <span class="m">0</span>



<span class="c1"># TOMCAT Checks</span>
<span class="c1">#command[check_tomcat]=/usr/lib/nagios/plugins/check_tomcat -H localhost -p 8080 -w 10%,50 -c 5%,10 -l nagios -a i1I605LzIG7V</span>
command<span class="o">[</span>check_tomcat<span class="o">]=</span>/usr/lib/nagios/plugins/check_tomcat <span class="m">10</span> <span class="m">80</span> <span class="m">10</span> admin Masehare

<span class="c1"># Percona/MySQL Checks</span>
command<span class="o">[</span>check_percona_cluster_size<span class="o">]=</span>sudo /usr/lib64/nagios/plugins/pmp-check-mysql-status -x wsrep_cluster_size -C <span class="s1">&#39;&lt;=&#39;</span> -w <span class="m">2</span> -c <span class="m">1</span>
command<span class="o">[</span>check_percona_primary_cluster<span class="o">]=</span>sudo /usr/lib64/nagios/plugins/pmp-check-mysql-status -x wsrep_cluster_status -C <span class="o">==</span> -T str -c non-Primary
command<span class="o">[</span>check_percona_local_node_sync<span class="o">]=</span>sudo /usr/lib64/nagios/plugins/pmp-check-mysql-status -x wsrep_local_state_comment -C <span class="s1">&#39;!=&#39;</span> -T str -w Synced
command<span class="o">[</span>check_percona_flow_control<span class="o">]=</span>sudo /usr/lib64/nagios/plugins/pmp-check-mysql-status -x wsrep_flow_control_paused -w <span class="m">0</span>.1 -c <span class="m">0</span>.9
command<span class="o">[</span>check_mysql_status<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-status <span class="nv">$ARG1</span>$
command<span class="o">[</span>check_mysql_processlist<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-processlist
command<span class="o">[</span>check_mysql_innodb<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-innodb -C <span class="nv">$ARG1</span>$
command<span class="o">[</span>check_mysql_status_uptime<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-status x Uptime -C <span class="s1">&#39;&lt;&#39;</span> -w <span class="nv">$ARG1</span>$ -c <span class="nv">$ARG2</span>$
command<span class="o">[</span>check_mysql_status_connx<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-status -x Threads_connected -o / -y max_connections -T pct -w <span class="nv">$ARG1</span>$ -c <span class="nv">$ARG2</span>$
command<span class="o">[</span>check_mysql_status_threadrun<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-status -x Threads_running -w <span class="nv">$ARG1</span>$ -c <span class="nv">$ARG2</span>$
command<span class="o">[</span>check_mysql_slave_running<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-replication-running
command<span class="o">[</span>check_mysql_slave_delay<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mysql-replication-delay

<span class="c1"># MemSQL Checks - ALL</span>
command<span class="o">[</span>check_memsql_orphans<span class="o">]=</span>/usr/lib/nagios/plugins/check_memsql_orphans
command<span class="o">[</span>check_memsql_stat_only<span class="o">]=</span>/usr/lib/nagios/plugins/check_memsql_dbs_only
command<span class="o">[</span>check_memsql_memory<span class="o">]=</span>/usr/lib/nagios/plugins/check_memsql_mem
command<span class="o">[</span>check_port_3306_on_all_memsql_nodes<span class="o">]=</span>/usr/lib/nagios/plugins/check_memsql_connections

<span class="c1"># MemSQL Checks - mem_master</span>

<span class="c1"># NGINX Checks</span>
command<span class="o">[</span>check_nginx_status<span class="o">]=</span>/usr/lib/nagios/plugins/check_nginx_status -H localhost -P <span class="m">9396</span> -w <span class="m">10000</span> -c <span class="m">20000</span>
command<span class="o">[</span>check_nginx_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs --argument-array<span class="o">=</span><span class="s2">&quot;/usr/sbin/nginx -g daemon on; master_process on&quot;</span> -w <span class="m">1</span>:1 -c <span class="m">1</span>:1

<span class="c1"># Rabbit MQ Checks</span>
command<span class="o">[</span>check_rabbit_status<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n aliveness-test -q status
command<span class="o">[</span>check_rabbit_msg_ready<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q messages_ready -c <span class="m">2000</span> -w <span class="m">10000</span>
command<span class="o">[</span>check_rabbit_msg_unack<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q messages_unacknowledged -w <span class="m">0</span> -c <span class="m">10</span>
command<span class="o">[</span>check_rabbit_publish<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q publish_details
command<span class="o">[</span>check_rabbit_msg_ack<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q ack_details
command<span class="o">[</span>check_rabbit_deliver_get<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q deliver_get_details
command<span class="o">[</span>check_rabbit_msg_redeliver<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q redeliver_details -w <span class="m">40</span> -c <span class="m">80</span>
command<span class="o">[</span>check_rabbit_msg_deliver<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q deliver_details
command<span class="o">[</span>check_rabbit_deliver_no_ack<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q deliver_no_ack_details
command<span class="o">[</span>check_rabbit_get_no_ack<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n overview -q get_no_ack_details
command<span class="o">[</span>check_rabbit_memory<span class="o">]=</span>/usr/lib/nagios/plugins/check_rabbit_stat -n nodes -q memory

<span class="c1"># NODEJS Checks</span>
command<span class="o">[</span>check_node_pm2_status<span class="o">]=</span>/usr/bin/sudo -i -u serviceuser check_node_pm2 -A -S -R --rwarn <span class="m">5</span> --rcrit <span class="m">10</span>

<span class="c1"># Dockerswarm checks</span>
command<span class="o">[</span>check_docker_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs --argument-array<span class="o">=</span>/var/run/docker/containerd/containerd.toml -w <span class="m">1</span>:1 -c <span class="m">1</span>:1


<span class="c1">#</span>
<span class="c1"># Wordpress</span>
command<span class="o">[</span>check_glusterfs<span class="o">]=</span>/usr/lib/nagios/plugins/check_glusterfs -v wordpress_files -n <span class="m">2</span>
command<span class="o">[</span>check_php5fpm_status<span class="o">]=</span>/usr/lib/nagios/plugins/check_phpfpm_status -o linux -s php5-fpm
command<span class="o">[</span>check_php71fpm_status<span class="o">]=</span>/usr/lib/nagios/plugins/check_phpfpm_status -o linux -s php7.1-fpm
command<span class="o">[</span>check_wpress_version<span class="o">]=</span>/usr/lib/nagios/plugins/check_wp_version

<span class="c1"># Glusterfs Checks</span>
command<span class="o">[</span>check_gluster_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs --argument-array<span class="o">=</span><span class="s2">&quot;/usr/sbin/glusterd -p /var/run/glusterd.pid&quot;</span> -w <span class="m">1</span>:1 -c <span class="m">1</span>:1
command<span class="o">[</span>check_glusterfs_health<span class="o">]=</span>/usr/lib/nagios/plugins/check_glusterfs_health

<span class="c1"># Gitlab Checks</span>
command<span class="o">[</span>check_gitlab_procs<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs --argument-array<span class="o">=</span>/etc/gitlab-runner/config.toml -c <span class="m">1</span>:1

<span class="c1"># ClusterControl Checks</span>
command<span class="o">[</span>check_cluster_control<span class="o">]=</span>/usr/lib/nagios/plugins/check_cluster_control

<span class="c1"># MongoDB</span>
command<span class="o">[</span>check_mongo_connections<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_connections
command<span class="o">[</span>check_mongo_election<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_election
command<span class="o">[</span>check_mongo_repl_lag<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_repl_lag
command<span class="o">[</span>check_mongo_flushing<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_flushing
command<span class="o">[</span>check_mongo_total_indexes<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_total_indexes
command<span class="o">[</span>check_mongo_balance<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_balance
command<span class="o">[</span>check_mongo_queues<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_queues
command<span class="o">[</span>check_mongo_cannary_test<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_cannary_test
command<span class="o">[</span>check_mongo_have_primary<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_have_primary
command<span class="o">[</span>check_mongo_connect<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_connect
command<span class="o">[</span>check_mongo_oplog<span class="o">]=</span>/usr/lib64/nagios/plugins/pmp-check-mongo.py -A check_oplog

<span class="c1">## Elasticsearch</span>
command<span class="o">[</span>check_elasticsearch<span class="o">]=</span>/usr/lib/nagios/plugins/check_elasticsearch.sh -H localhost -u elastic -p tusfDtzYSEtb

<span class="c1">## ZFS</span>
command<span class="o">[</span>check_zfs_pool_health<span class="o">]=</span>/usr/lib/nagios/plugins/check_zfs_pool_health

<span class="c1">## Netflow</span>
command<span class="o">[</span>check_OpManager<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -a OpManager

<span class="c1">## Zabbix</span>
command<span class="o">[</span>check_zabbix_server<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -c <span class="m">1</span>: -w <span class="m">3</span>: -C zabbix_server
command<span class="o">[</span>check_zabbix_agent<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -c <span class="m">1</span>: -w <span class="m">3</span>: -C zabbix_agentd
command<span class="o">[</span>check_mysql<span class="o">]=</span>/usr/lib/nagios/plugins/check_procs -a mysql
</pre></div>
</div>
<p><strong>File check_mem</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-w&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;0&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-c&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">FreeM</span><span class="o">=</span><span class="sb">`</span>free -m<span class="sb">`</span>
        <span class="nv">memTotal_m</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FreeM</span><span class="s2">&quot;</span> <span class="p">|</span>grep Mem <span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
        <span class="nv">memUsed_m</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FreeM</span><span class="s2">&quot;</span> <span class="p">|</span>grep Mem <span class="p">|</span>awk <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
        <span class="nv">memFree_m</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FreeM</span><span class="s2">&quot;</span> <span class="p">|</span>grep Mem <span class="p">|</span>awk <span class="s1">&#39;{print $4}&#39;</span><span class="sb">`</span>
        <span class="nv">memBuffer_m</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FreeM</span><span class="s2">&quot;</span> <span class="p">|</span>grep Mem <span class="p">|</span>awk <span class="s1">&#39;{print $6}&#39;</span><span class="sb">`</span>
        <span class="nv">memCache_m</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FreeM</span><span class="s2">&quot;</span> <span class="p">|</span>grep Mem <span class="p">|</span>awk <span class="s1">&#39;{print $7}&#39;</span><span class="sb">`</span>
        <span class="nv">memUsed_m</span><span class="o">=</span><span class="k">$((</span><span class="nv">$memUsed_m</span> <span class="o">-</span> <span class="nv">$memCache_m</span><span class="k">))</span>
        <span class="nv">memUsedPrc</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">$((</span><span class="o">(</span><span class="nv">$memUsed_m</span><span class="o">*</span><span class="m">100</span><span class="o">)/</span><span class="nv">$memTotal_m</span><span class="k">))</span><span class="o">||</span>cut -d. -f1<span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$memUsedPrc</span><span class="s2">&quot;</span> -ge <span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">echo</span> <span class="s2">&quot;Memory: CRITICAL Total: </span><span class="nv">$memTotal_m</span><span class="s2"> MB - Used: </span><span class="nv">$memUsed_m</span><span class="s2"> MB - </span><span class="nv">$memUsedPrc</span><span class="s2">% used!|TOTAL=</span><span class="nv">$memTotal_m</span><span class="s2">;;;; USED=</span><span class="nv">$memUsed_m</span><span class="s2">;;;; CACHE=</span><span class="nv">$memCache_m</span><span class="s2">;;;; BUFFER=</span><span class="nv">$memBuffer_m</span><span class="s2">;;;;&quot;</span>
                <span class="nb">exit</span> <span class="m">2</span>
        <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$memUsedPrc</span><span class="s2">&quot;</span> -ge <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">echo</span> <span class="s2">&quot;Memory: WARNING Total: </span><span class="nv">$memTotal_m</span><span class="s2"> MB - Used: </span><span class="nv">$memUsed_m</span><span class="s2"> MB - </span><span class="nv">$memUsedPrc</span><span class="s2">% used!|TOTAL=</span><span class="nv">$memTotal_m</span><span class="s2">;;;; USED=</span><span class="nv">$memUsed_m</span><span class="s2">;;;; CACHE=</span><span class="nv">$memCache_m</span><span class="s2">;;;; BUFFER=</span><span class="nv">$memBuffer_m</span><span class="s2">;;;;&quot;</span>
                <span class="nb">exit</span> <span class="m">1</span>
        <span class="k">else</span>
                <span class="nb">echo</span> <span class="s2">&quot;Memory: OK Total: </span><span class="nv">$memTotal_m</span><span class="s2"> MB - Used: </span><span class="nv">$memUsed_m</span><span class="s2"> MB - </span><span class="nv">$memUsedPrc</span><span class="s2">% used|TOTAL=</span><span class="nv">$memTotal_m</span><span class="s2">;;;; USED=</span><span class="nv">$memUsed_m</span><span class="s2">;;;; CACHE=</span><span class="nv">$memCache_m</span><span class="s2">;;;; BUFFER=</span><span class="nv">$memBuffer_m</span><span class="s2">;;;;&quot;</span>
                <span class="nb">exit</span> <span class="m">0</span>
        <span class="k">fi</span>
<span class="k">else</span>    <span class="c1"># If inputs are not as expected, print help.</span>
        <span class="nv">sName</span><span class="o">=</span><span class="s2">&quot;`echo </span><span class="nv">$0</span><span class="s2">|awk -F &#39;/&#39; &#39;{print </span><span class="nv">$NF</span><span class="s2">}&#39;`&quot;</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\n\n\t\t### </span><span class="nv">$sName</span><span class="s2"> Version 2.0###\n&quot;</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;# Usage:\t</span><span class="nv">$sName</span><span class="s2"> -w &lt;warnlevel&gt; -c &lt;critlevel&gt;&quot;</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\t\t= warnlevel and critlevel is percentage value without %\n&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;# EXAMPLE:\t/usr/lib64/nagios/plugins/</span><span class="nv">$sName</span><span class="s2"> -w 80 -c 90&quot;</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\nCopyright (C) 2012 Lukasz Gogolin (lukasz.gogolin@gmail.com), improved by Nestor 2015\n\n&quot;</span>
        <span class="nb">exit</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">### On the Nagios Box</span>
<span class="c1"># Check the log, grepping a part of the server name you what to see a log for</span>
tail -f /var/log/nagios3/nagios.log <span class="p">|</span> grep netflow

<span class="c1">### On the Host to Monitor</span>
<span class="c1">## Test to see if you can run the checks (these are found in /etc/nagios/nrpe.d/custom_nrpe.cfg)</span>
<span class="c1"># CPU Load</span>
/usr/lib/nagios/plugins/check_load -r -w <span class="m">2</span>.5,2,1.5 -c <span class="m">4</span>,3.5,3

<span class="c1"># Disk vda1 Status</span>
/usr/lib/nagios/plugins/check_disk -w <span class="m">10</span>% -c <span class="m">5</span>% -x tmpfs -x udev -x /snap/*

<span class="c1"># Memory</span>
/usr/lib/nagios/plugins/check_mem -w <span class="m">85</span> -c <span class="m">95</span>

<span class="c1"># Total Procs</span>
/usr/lib/nagios/plugins/check_procs -w <span class="m">600</span> -c <span class="m">800</span>

<span class="c1"># Users Check</span>
/usr/lib/nagios/plugins/check_users -w <span class="m">10</span> -c <span class="m">20</span>

<span class="c1"># Zombie Procs</span>
/usr/lib/nagios/plugins/check_procs -w <span class="m">5</span> -c <span class="m">10</span> -s Z
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="networking.html" class="btn btn-neutral float-right" title="Networking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="monitoring.html" class="btn btn-neutral float-left" title="Monitoring" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Caleb Sargeant.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>